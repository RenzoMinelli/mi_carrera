name: Scraper
on:
  push:
    branches:
      - 'gh-action-scraper'
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: ruby/setup-ruby@v1
      with:
        bundler-cache: true
    - name: Run scraper
      env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
      run: |
          bundle exec rake scraper
          git config --global user.email "micarrera@cedarcode.com"
          git config --global user.name "MiCarrera"
          git add db/data
          CHANGED_FILES=$(git status --porcelain | grep -v '^??')
          if [ -n "$CHANGED_FILES" ]; then
            git commit -m 'Update db/data from scraper'
            git push -f origin HEAD:scraper

            gh pr create --title "Scraper Updates" --body "Updates from scraper" --head scraper
          else
            echo "No changes detected"
          fi
